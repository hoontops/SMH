<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="smh.apr.dao.APR20210Dao">
   	<!-- 업적평가-파트장평가(Master) 수정 update -->
	<update id="updatePartEvaluationMaster" parameterType="map" >
		/* smh.apr.dao.APR20210Dao.updatePartEvaluationMaster */
		UPDATE HJSPFM_PERSON_OBJECT_MASTER 
	      SET 
	           PARTICIPANT_ACHITED_RATING1 = #{CONV_MGR_NOTICE1}
	          ,CONV_MGR_NOTICE1 = #{CONV_MGR_NOTICE1}
	          ,CONV_MGR_SCORE1 = #{CONV_MGR_SCORE1}     
	          ,PARTICIPANT_ACHITED_COMMENT = #{PARTICIPANT_ACHITED_COMMENT}
	          ,LAST_UPDATED_BY = #{PERSONID}     
	          ,LAST_UPDATE_DATE = SYSDATE 
	     WHERE HJSPFM_PER_OBJECT_MASTER_SEQ = #{HJSPFM_PER_OBJECT_MASTER_SEQ}
	</update>
	<!-- 업적평가-파트장평가(Appraisal Master) 수정 update -->
	<update id="updatePartEvaluationAppraisalMaster" parameterType="map" >
		/* smh.apr.dao.APR20210Dao.updatePartEvaluationAppraisalMaster */
		UPDATE HJSPFM_APPRAISAL_MASTER 
	      SET 
	           PART_APPRAISAL_SCORE_1 = #{CONV_MGR_SCORE1}
	          ,LAST_UPDATED_BY = #{PERSONID}     
	          ,LAST_UPDATE_DATE = SYSDATE 
	     WHERE HJSPFM_APPRAISAL_MASTER_SEQ = #{HJSPFM_APPRAISAL_MASTER_SEQ}
	</update>
	<!-- 업적평가-파트장평가 수정 update -->
	<update id="updatePartEvaluationDetail" parameterType="map" >
		/* smh.apr.dao.APR20210Dao.updatePartEvaluationDetail */
		UPDATE HJSPFM_PERSON_OBJECT_DETAIL 
	      SET 
	           APPRAISAL_COMMENTS1 = #{APPRAISAL_COMMENTS1}     
	          ,OBJECT_VERSION_NUMBER = (
		      							SELECT OBJECT_VERSION_NUMBER + 1
		      							FROM HJSPFM_PERSON_OBJECT_DETAIL
		      							WHERE HJSPFM_PER_OBJECT_DETAIL_SEQ = #{HJSPFM_PER_OBJECT_DETAIL_SEQ}
		      							)      
	          ,LAST_UPDATED_BY = #{PERSONID}     
	          ,LAST_UPDATE_DATE = SYSDATE 
	     WHERE HJSPFM_PER_OBJECT_DETAIL_SEQ = #{HJSPFM_PER_OBJECT_DETAIL_SEQ}
	</update>
	<!-- 업적평가-피평가자 등급조회 -->
	<select id="selectPerformanceRating" parameterType="map" resultType="hashmap">
    /* smh.apr.dao.APR20210Dao.selectPerformanceRating */
    SELECT  HOR.APPRAISAL_YEAR                AS APPRAISAL_YEAR
	       ,HOR.APPRAISAL_SEQUENCE            AS APPRAISAL_SEQUENCE
	       ,HOR.ORG_NAME                      AS ORG_NAME
	       ,HL.MEANING                        AS ORG_TYPE_NAME
	       ,HOR.PERFORMANCE_RATING            AS PERFORMANCE_RATING_ID 
	       ,PRL.NAME                          AS PERFORMANCE_RATING      -- 조직등급
	       ,HL2.LOOKUP_CODE                   AS LOOKUP_CODE
	       ,HL2.MEANING                       AS STATUS_NAME
	       ,HAOU.ORGANIZATION_ID              AS ORGANIZATION_ID
	       ,HJSPFM_WEB_SM_APPRAISAL_PKG.ORG_SCORE(HOR.ORGANIZATION_ID, HOR.APPRAISAL_YEAR, HOR.APPRAISAL_SEQUENCE, TO_DATE(#{EFFECTIVE_END_DATE},'YYYYMMDD')) AS ORG_SCORE     -- 조직점수
	       ,HJSPFM_WEB_SM_APPRAISAL_PKG.TEAM_CNT(HOR.ORGANIZATION_ID, HOR.APPRAISAL_YEAR, HOR.APPRAISAL_SEQUENCE, TO_DATE(#{EFFECTIVE_END_DATE},'YYYYMMDD'))  AS TEAM_CNT      -- 피평가자 점수
	       ,HJSPFM_WEB_SM_APPRAISAL_PKG.TEAM_GET_SCORE(HOR.ORGANIZATION_ID, HOR.APPRAISAL_YEAR, HOR.APPRAISAL_SEQUENCE, TO_DATE(#{EFFECTIVE_END_DATE},'YYYYMMDD')) AS TEAM_GET_SCORE 
	       ,HJSPFM_WEB_SM_APPRAISAL_PKG.ORG_SCORE(HOR.ORGANIZATION_ID, HOR.APPRAISAL_YEAR, HOR.APPRAISAL_SEQUENCE, TO_DATE(#{EFFECTIVE_END_DATE},'YYYYMMDD'))
	       - HJSPFM_WEB_SM_APPRAISAL_PKG.TEAM_GET_SCORE(HOR.ORGANIZATION_ID, HOR.APPRAISAL_YEAR, HOR.APPRAISAL_SEQUENCE, TO_DATE(#{EFFECTIVE_END_DATE},'YYYYMMDD')) AS TEAM_REMAIN_SCORE  -- 피평가자 잔여점수
	 FROM   HJSPFM_ORGANIZATION_RESULT  HOR
	       ,HR_ORGANIZATION_INFORMATION HOI
	       ,HR_ALL_ORGANIZATION_UNITS   HAOU
	       ,PER_ALL_PEOPLE_F            PAPF
	       ,FND_LOOKUP_VALUES           HL
	       ,FND_LOOKUP_VALUES           HL2
	       ,PER_RATING_LEVELS           PRL
	       ,HJSHR_WEB_ORGANIZATION_LOV_V HOL
	 WHERE  1=1
	 AND    HOR.APPRAISAL_YEAR  = #{APPRAISAL_YEAR}   -- 평가년도
	 AND    HOR.APPRAISAL_SEQUENCE = #{APPRAISAL_SEQUENCE}   -- 평가차수
	 AND    HAOU.ORGANIZATION_ID   = #{ORGANIZATION_ID}  -- 피평가자 조직ID
	 AND    HOR.ORGANIZATION_ID = HAOU.ORGANIZATION_ID
	 AND    HAOU.ORGANIZATION_ID = HOI.ORGANIZATION_ID
	 AND    HOL.CHILD_ORGANIZATION_ID = HOR.ORGANIZATION_ID
	 AND    PAPF.PERSON_ID = HOI.ORG_INFORMATION2
	 AND    HL.LOOKUP_TYPE = 'ORG_TYPE'
	 AND    HL2.LOOKUP_TYPE = 'HJS_HR_ORG_PERFORM_STATUS_LOV'
	 AND    HOR.STATUS = HL2.LOOKUP_CODE
	 AND    HL.LOOKUP_CODE = HAOU.TYPE
	 AND    PRL.RATING_LEVEL_ID(+) = HOR.PERFORMANCE_RATING
	 AND    HOI.ORG_INFORMATION_CONTEXT = 'Organization Name Alias'
	 AND    TO_DATE(#{EFFECTIVE_END_DATE},'YYYYMMDD') BETWEEN TO_DATE(SUBSTR(HOI.ORG_INFORMATION3, 1, 10), 'yyyy/mm/dd') 
	                           AND NVL(TO_DATE(SUBSTR(HOI.ORG_INFORMATION4, 1, 10), 'yyyy/mm/dd'), TO_DATE('4712/12/31', 'yyyy/mm/dd'))
	 AND    TO_DATE(#{EFFECTIVE_END_DATE},'YYYYMMDD') BETWEEN PAPF.EFFECTIVE_START_DATE AND PAPF.EFFECTIVE_END_DATE
	 ORDER BY HOL.ORDER_BY
    </select> 
	
</mapper>
