<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="smh.pcm.dao.PCM02700Dao">

	   <!--  인계 취소 리스트 조회 -->
	   <!-- 수정 : 2021.04.27(김기수) : Step제한 변경 -->
     <select id="selectLotListForSendCancel" parameterType="map" resultType="hashmap">
				SELECT  DISTINCT
						NULL	CHK
					,	L.LOTID
					,	L.PROCESSSEGMENTID
					,	L.PROCESSSEGMENTVERSION
					,	COALESCE(PSN.DICTIONARYNAME, PS.PROCESSSEGMENTNAME)	AS PROCESSSEGMENTNAME
					,	L.PRODUCTDEFID
					,	L.PRODUCTDEFVERSION
					,	PD.PRODUCTDEFNAME
					,	L.UNIT
					,	L.QTY
					,	L.PRODUCTIONORDERID
					,	L.LINENO
					,	L.AREAID
					,	COALESCE(AN.DICTIONARYNAME, A.AREANAME)	AS AREANAME
					,	TO_CHAR(PLH.SENDTIME, 'YYYY-MM-DD HH24:MI:SS')		AS SEGMENTINCOMETIME
					,	L.PANELQTY
					,	L.USERSEQUENCE
					,	L.LOTSTATE
				FROM	PCM_LOT						L
				INNER JOIN PCM_LOTWORKRESULT			WR	ON	L.LOTID = WR.LOTID
														AND	L.PROCESSSEGMENTID = WR.PROCESSSEGMENTID
														AND	L.WORKCOUNT = WR.WORKCOUNT
				LEFT JOIN PCM_LOTHISTORY			PLH	ON	WR.PREVSENDLOTHISTKEY = PLH.TXNHISTKEY
														AND	WR.LOTID = PLH.LOTID
				INNER JOIN BAS_PROCESSSEGMENT		PS	ON	L.ENTERPRISEID = PS.ENTERPRISEID
				--										AND	L.PLANTID = PS.PLANTID
														AND	L.PROCESSSEGMENTID = PS.PROCESSSEGMENTID
														AND	L.PROCESSSEGMENTVERSION = PS.PROCESSSEGMENTVERSION
				LEFT OUTER JOIN CMD_DICTIONARY		PSN	ON	PS.PROCESSSEGMENTNAME = PSN.DICTIONARYID
														AND	PSN.LANGUAGETYPE = #{LANGUAGETYPE}
				INNER JOIN BAS_PRODUCTDEFINITION		PD	ON	L.ENTERPRISEID = PD.ENTERPRISEID
												--		AND	L.PLANTID = PD.PLANTID
														AND	L.PRODUCTDEFID = PD.PRODUCTDEFID
														AND	L.PRODUCTDEFVERSION = PD.PRODUCTDEFVERSION
				INNER JOIN BAS_AREA					A	ON	L.AREAID = A.AREAID
				LEFT OUTER JOIN CMD_DICTIONARY		AN	ON	A.AREANAME = AN.DICTIONARYID
														AND	AN.LANGUAGETYPE = #{LANGUAGETYPE}
				LEFT OUTER JOIN FN_AREA(#{USERID})	AL	ON	A.AREAID = AL.AREAID
														AND	AL.ISMODIFY = 'Y'
				INNER JOIN BAS_PROCESSPATH			PP	ON	L.PROCESSDEFID = PP.PROCESSDEFID
														AND	L.PROCESSDEFVERSION = PP.PROCESSDEFVERSION
														AND	L.PROCESSSEGMENTID = PP.PROCESSSEGMENTID
														AND	L.PROCESSSEGMENTVERSION = PP.PROCESSSEGMENTVERSION
														AND PP.VALIDSTATE='Valid'
				LEFT OUTER JOIN BAS_PROCESSPATH		PPP	ON	L.PROCESSDEFID = PPP.PROCESSDEFID
														AND	L.PROCESSDEFVERSION = PPP.PROCESSDEFVERSION
														AND	PP.PATHSEQUENCE - 1 = PPP.PATHSEQUENCE
														AND PPP.VALIDSTATE='Valid'
				LEFT OUTER JOIN BAS_PROCESSSEGMENT	PPS	ON	PLH.PREVPROCESSSEGMENTID = PPS.PROCESSSEGMENTID
				--										AND	PPP.PROCESSSEGMENTVERSION = PPS.PROCESSSEGMENTVERSION
				LEFT OUTER JOIN 	FN_GETSTEPTYPE() ST1 ON PPS.STEPCLASS=ST1.CODE															
				
				WHERE	1 = 1
				AND		L.ENTERPRISEID = #{ENTERPRISEID}
				AND		L.PLANTID = #{PLANTID}
				AND		AL.AREAID = #{AREAID}
				<if test="LOTID != null and LOTID !='' ">
				AND		L.LOTID LIKE '%'||#{LOTID}|| '%'
				</if>
				AND		L.PROCESSSTATE = #{PROCESSSTATE}
				AND		L.LOTCREATEDTYPE IN ('Normal','SplitRoll', 'FinalInspect', 'Repair', 'Return')
				AND		L.LOTSTATE IN ('InProduction','InTransit','Finished')
				AND		PP.PATHTYPE != 'Start'
				AND		A.AREATYPE != 'OutsideOSP'
				<if test="PRODUCTDEFID != null and PRODUCTDEFID !='' ">
					AND		L.PRODUCTDEFID = #{PRODUCTDEFID}
				</if>
    </select>
    
    	   <!--  인계 취소 리스트 조회 -->
     <select id="GetLotWorkResultCount" parameterType="map" resultType="hashmap">
		SELECT
				CASE WHEN COUNT(*) = 0 THEN 0
					 ELSE MAX(WORKCOUNT) + 1
				END						AS RESULTCNT
		FROM	PCM_LOTWORKRESULT		LWR
		WHERE	1 = 1
		AND		LWR.LOTID = #{LOTID}
		AND		LWR.PROCESSSEGMENTID = #{PROCESSSEGMENTID}
		AND		COALESCE(LWR.RESULTTYPE, '') != 'SKIP'
    </select>
    
        	   <!--  물류 창고 확인 -->
     <select id="selectOspWareHouseIn" parameterType="map" resultType="hashmap">
		SELECT LOTID
		FROM	OSM_OSPRECEIPTSENDLOT
		WHERE	LOTID = #{LOTID}
			AND RECEIPTDATE IS NOT NULL
			AND SENDDATE IS NULL
    </select>
    
       <!--  인계 취소 리스트 조회 -->
     <select id="selectLotWorkResultOrderByWorkCount" parameterType="map" resultType="hashmap">
		SELECT
			*
		FROM PCM_LOTWORKRESULT
		WHERE 1=1
			AND ENTERPRISEID = #{ENTERPRISEID}
			AND PLANTID = #{PLANTID}
			AND LOTID = #{LOTID}
			AND PROCESSSEGMENTID = #{PROCESSSEGMENTID}
			AND PROCESSSEGMENTVERSION = #{PROCESSSEGMENTVERSION}
		ORDER BY WORKCOUNT DESC;
    </select>
    
    
    <update id="updatePcmLotDataForCancelFinishLot" parameterType="hashmap">
    	UPDATE PCM_LOT	SET		/* updatePcmLotDataForCancelFinishLot */
    			SENDUSER = #{SENDUSER} 
    		,	SENDTIME = #{SENDTIME}
    		,	TRACKOUTTIME = #{TRACKOUTTIME}
    		,	TRACKOUTUSER = #{TRACKOUTUSER}
    		,	TRACKINTIME = #{TRACKINTIME}
    		,	TRACKINUSER = #{TRACKINUSER}
    		,	PROCESSSTATE = #{PROCESSSTATE}
    		,	LOTSTATE = #{LOTSTATE}
    		,	MODIFIEDTIME = SYSDATE
    		,	MODIFIER = #{MODIFIER}
    		,	LASTTXNUSER = #{TXNUSER}
    		,	LASTTXNID = #{TXNID}
    		,	LASTTXNHISTKEY = #{TXNHISTKEY}
    	WHERE 1=1
    		AND LOTID = #{LOTID}
    </update>
    
    <select id="getExistLotWorkResultInfo" parameterType="map" resultType="hashmap">
		SELECT		/*getExistLotWorkResultInfo*/
				TXNHISTKEY
			,	PROCESSSEGMENTID
			,	PROCESSSEGMENTVERSION
			,	SENDTIME
			,	COALESCE(WORKCOUNT,0)	AS	WORKCOUNT
		FROM	PCM_LOTWORKRESULT
		WHERE 1=1
			AND	LOTID = #{LOTID}
			AND	PROCESSSEGMENTID = #{PROCESSSEGMENTID}
			AND	PROCESSSEGMENTVERSION = #{PROCESSSEGMENTVERSION}
			AND	PRODUCTIONORDERID = #{PRODUCTIONORDERID}
			AND	PRODUCTDEFID = #{PRODUCTDEFID}
			AND PRODUCTDEFVERSION = #{PRODUCTDEFVERSION}
    </select>
    
       <update id="updateLotWorkResultCancel" parameterType="hashmap">
    	UPDATE PCM_LOTWORKRESULT	SET		/* updatePcmLotDataForCancelFinishLot */
    			WORKSTARTTIME = #{WORKSTARTTIME}
    		,	WORKSTARTUSER = #{WORKSTARTUSER}
    		,	WORKSTARTPCSQTY = #{WORKSTARTPCSQTY}
    		,	WORKSTARTPANELQTY = #{WORKSTARTPANELQTY}
    		,	WORKENDTIME = #{WORKENDTIME}
    		,	WORKENDUSER = #{WORKENDUSER}
    		,	WORKENDPCSQTY = #{WORKENDPCSQTY}
    		,	WORKENDPANELQTY = #{WORKENDPANELQTY}
    		,	SENDTIME = #{SENDTIME}
    		,	SENDUSER = #{SENDUSER}
    		,	SENDPCSQTY = #{SENDPCSQTY}
    		,	SENDPANELQTY = #{SENDPANELQTY}
    		,	MODIFIER =#{MODIFIER}
    		,	MODIFIEDTIME = SYSDATE
    	WHERE 1=1
    		AND LOTID = #{LOTID}
    		AND TXNHISTKEY = #{TXNHISTKEY}
    </update>
    
    <update id="updateLotEquipmentData" parameterType="hashmap">
    	UPDATE PCM_LOTEQUIPMENT	SET		/* updateLotEquipmentData */
    			TRACKOUTTIME = null
    	WHERE 1=1
    		AND LOTID = #{LOTID}
    		AND WORKCOUNT = #{WORKCOUNT}
    		AND PROCESSSEGMENTID = #{PROCESSSEGMENTID}
    </update>
    
   <select id="selectItemWareHouseData" parameterType="map" resultType="hashmap">
		SELECT		/*selectItemWareHouseData*/
			NVL(B.WAREHOUSEID , A.WAREHOUSEID) AS WAREHOUSEID
		FROM	BAS_ITEMWAREHOUSE	A
		LEFT OUTER JOIN	MTM_CONSUMABLELOT	B	ON	A.ITEMID = B.CONSUMABLEDEFID
												AND A.ITEMVERSION = B.CONSUMABLEDEFVERSION
												AND B.CONSUMABLELOTID = #{LOTID}
		WHERE 1=1 
			AND A.ITEMID = #{PRODUCTDEFID}
			AND A.ITEMVERSION = #{PRODUCTDEFVERSION}
		
    </select>
    <select id="selectOnHandDataList" parameterType="map" resultType="hashmap">
		SELECT		/*selectOnHandDataList*/
			ONHAND_QTY
		FROM	IFC_MES_S_ONHAND_V@ERPPROD
		WHERE 1=1 
			AND ITEM_CODE = #{PRODUCTDEFID}||#{PRODUCTDEFVERSION}
			AND	SUBINVENTORY_CODE = #{WAREHOUSECODE}
			AND LOT_NUMBER = #{LOTID}
		
    </select>
    
</mapper>
